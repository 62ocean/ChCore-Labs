# 实验2 - 实验报告

## 思考题1

优：当应用进程使用的虚拟地址远小于总的虚拟空间时，多级页表更节省空间（因为没有用到的页表不会申请）。  
劣：当应用进程使用的虚拟地址与总虚拟空间差不多时，多级页表更占用空间（因为有多余的L0,L1,L2页表）。多级页表的查询过程更复杂。  

4KB:  
1个L0，4个L1，$512 * 4$个L2，$512 * 4 * 4$个L3。总计1050629。  
2MB:  
1个L0，4个L1，$512 * 4$个L2，无L3。总计2053。

## 思考题3

刚开启MMU时，ChCore使用的是虚拟地址，但此时还没有跳转到高地址位置，所以需要配置页表使虚拟地址与物理地址一一对应，等到跳转到高地址区域后再使用高地址页表。  

验证：去掉为低地址配置的页表，程序不能正常跳转到main函数。

## 思考题4
`kernel/arch/aarch64/boot/raspi3/init/tools.s`226行的`el1_mmu_activate`函数中
```
adrp    x8, boot_ttbr0_l0
msr     ttbr0_el1, x8
adrp    x8, boot_ttbr1_l0
msr     ttbr1_el1, x8
isb
```
将`boot_ttbr0_l0`数组的位置和`boot_ttbr1_l0`数组的位置分别放入了`ttbr0_el1`和`ttbr1_el1`寄存器。  
isb是指令同步屏障，确保所有在ISB指令之后的指令都从指令高速缓存或内存中重新预取。这样可以保证isb指令之后的指令都是使用新的页表获取地址。

## 思考题8

在操作系统中支持写时拷贝需要配置页表描述符的AP字段。AP字段是访问权限字段，它指定了访问该页的权限。在写时拷贝中，AP字段应该设置为只读，以便多个进程可以共享同一块内存。  

当进程试图写入只读页时，会发生缺页异常。在这种情况下，操作系统会为该进程分配一个新的物理页，并将该页的内容复制到新的物理页中。然后，操作系统会更新页表，以便该页指向新的物理页。这样，该进程就可以修改其私有副本，而不会影响其他进程。

## 思考题9

如果需要更精细的映射，使用粗粒度映射表可能会导致映射的精度不够，无法满足需求。容易产生内部碎片。