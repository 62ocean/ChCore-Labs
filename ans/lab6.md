# 实验6 - 实验报告

## 思考题1

1. 在circle中，SDHost是一个SD卡的主机控制器，EMMC是一个集成了MMC和SD卡控制器的芯片。SD卡和EMMC都可以通过SDHost进行控制和访问。SDHost提供了一个标准的接口，使得SD卡和EMMC可以通过相同的方式进行访问和控制。

2. Chcore通过MMIO（Memory-Mapped I/O）的方式与SD卡进行交互。Chcore将SD卡的寄存器映射到内存空间中，然后通过读写内存的方式来访问SD卡的寄存器。Chcore发出的指令是通过IssueCommand函数来实现的。该函数会将指令写入SD卡的命令寄存器中，并等待SD卡的响应。SD卡的响应是通过中断的方式返回的，Chcore会在中断处理函数中读取SD卡的响应。

3. 首先，调用map_mmio函数将SD卡的内存映射区域映射到Chcore的内存区域。接下来，调用Initialize函数初始化SD卡。该函数设置SD卡的时钟和电压水平，并向卡发送初始化命令。最后，调用ipc_register_server函数将SD驱动注册为IPC服务器。

4. 在驱动代码的初始化中，设置时钟频率的意义是为了使SD卡和主机之间的通信同步。SD卡和主机之间的通信需要使用时钟信号进行同步，因此需要设置合适的时钟频率。TimeoutWait函数的作用是等待一段时间，以确保SD卡已经完成了相应的操作。在初始化过程中，需要等待SD卡的响应，因此需要调用TimeoutWait函数进行等待。

## 思考题2

SD卡是通过分区表进行分区的，分区表是卡上包含有关卡上分区的信息的小部分。分区表通常位于卡的第一个扇区中，并包含有关每个分区的大小和位置的信息。

一旦读取了分区表，操作系统就可以识别每个分区上的文件系统。这是通过检查每个分区的引导扇区来完成的，引导扇区包含有关文件系统类型和文件系统根目录位置的信息。

为了访问特定分区上的文件，操作系统必须首先挂载该分区。这涉及将驱动器号或挂载点分配给分区，并使其对用户可访问。

设计：

1. 修改 main 函数，以初始化每个分区的文件系统驱动程序。可以使用分区表中的分区类型信息来确定要使用哪个文件系统驱动程序。

2. 修改 sd_dispatch 函数，以从 IPC 消息中解析分区号，挂载该分区的文件系统，并将分区号传递给 sdcard_readblock 和 sdcard_writeblock 函数。

3. 修改 sdcard_readblock 和 sdcard_writeblock 函数，以接受一个额外的参数分区号。根据分区号进行不同文件系统的读写操作。

4. 当通过 IPC 接收到读取或写入请求时，使用分区号确定要使用哪个文件系统驱动程序，并调用相应的读取或写入函数。
