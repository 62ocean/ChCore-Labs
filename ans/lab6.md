# 实验6 - 实验报告

## 思考题1

1. SD卡是常用的存储介质。eMMC作为常见SD控制器的一种，用于控制SD存储卡和SDIO设备的访问和通信。
  SDHost是一种标准的接口协议，eMMC控制器支持SDHost接口标准。

2. Chcore通过MMIO（Memory-Mapped I/O）的方式与SD卡进行交互。Chcore将SD卡的寄存器映射到内存空间中，然后通过读写内存的方式来访问SD卡的寄存器。Chcore发出的指令是通过IssueCommand函数来实现的。该函数会将指令写入SD卡的命令寄存器中，并等待SD卡的响应。SD卡的响应是通过中断的方式返回的，Chcore会在中断处理函数中读取SD卡的响应。

SD卡寄存器通过MMIO直接映射到物理地址空间中，CPU上的操作系统可以直接通过直接读写寄存器的方式将指令发送至SD卡寄存器处，SD卡发现寄存器值被更新，读取指令后再使用DMA的方式从内存中读取大量数据写入SD卡，或是将SD卡数据读至内存中，这一步不需要CPU的参与，IO设备直接与内存交互，完成DMA数据交互之后IO设备向CPU发送中断，CPU接受中断并进行相应处理。

3. 首先，调用map_mmio函数将SD卡的内存映射区域映射到Chcore的内存区域。接下来，调用Initialize函数初始化SD卡。该函数设置SD卡的时钟和电压水平，并向卡发送初始化命令。最后，调用ipc_register_server函数将SD驱动注册为IPC服务器。

4. 在驱动代码的初始化中，设置时钟频率的意义是为了使SD卡和主机之间的通信同步。SD卡和主机之间的通信需要使用时钟信号进行同步，因此需要设置合适的时钟频率。TimeoutWait函数的作用是等待一段时间，以确保SD卡已经完成了相应的操作。在初始化过程中，需要等待SD卡的响应，因此需要调用TimeoutWait函数进行等待。

## 思考题2

SD卡是通过分区表进行分区的，分区表是卡上包含有关卡上分区的信息的小部分。分区表通常位于卡的第一个扇区中，并包含有关每个分区的大小和位置的信息。

一旦读取了分区表，操作系统就可以识别每个分区上的文件系统。这是通过检查每个分区的引导扇区来完成的，引导扇区包含有关文件系统类型和文件系统根目录位置的信息。

为了访问特定分区上的文件，操作系统必须首先挂载该分区。这涉及将驱动器号或挂载点分配给分区，并使其对用户可访问。

设计：

1. 修改 main 函数，以初始化每个分区的文件系统驱动程序。可以使用分区表中的分区类型信息来确定要使用哪个文件系统驱动程序。

2. 修改 sd_dispatch 函数，以从 IPC 消息中解析分区号，挂载该分区的文件系统，并将分区号传递给 sdcard_readblock 和 sdcard_writeblock 函数。

3. 修改 sdcard_readblock 和 sdcard_writeblock 函数，以接受一个额外的参数分区号。根据分区号进行不同文件系统的读写操作。

4. 当通过 IPC 接收到读取或写入请求时，使用分区号确定要使用哪个文件系统驱动程序，并调用相应的读取或写入函数。

1. 分区: SD卡上的分区信息通常存储在分区表中，这是存储设备的一部分，通常位于设备的开头。最常见的分区表格式是MBR（Master Boot Record）和GPT（GUID Partition Table）。MBR是较旧的格式，它在设备的第一个扇区（即主引导记录）中存储分区信息。GPT是一个更现代的标准，它使用设备的前几个扇区来存储分区信息，并且支持超过2TB的存储设备。

2. 文件系统识别: 文件系统类型通常可以通过读取每个分区的开头部分来确定，这部分包含文件系统的元数据。例如，FAT文件系统在其引导扇区中包含一个特定的签名，可以用来识别文件系统。

为了在ChCore中支持SD卡的多分区，我们可以设计以下方案：

1. 分区解析: 在驱动初始化时，读取SD卡的开头部分来获取分区表。根据分区表的格式（MBR或GPT），解析出每个分区的开始位置和大小。

2. 文件系统挂载: 对于每个分区，读取其开头部分来确定文件系统类型。然后，使用相应的文件系统驱动来挂载该分区。如果文件系统类型未知或不支持，可以忽略该分区。

这个方案的实现需要对ChCore的存储驱动和文件系统支持进行一些扩展。具体来说，我们需要添加对MBR和GPT分区表的解析，以及对多种文件系统的支持。

以下是一个可能的实现步骤：

1. 在SD卡驱动中添加对MBR和GPT的支持。这可能需要读取SD卡的开头部分，并解析出分区表。

2. 扩展文件系统支持，以处理多种文件系统类型。这可能需要添加新的文件系统驱动，并在挂载时检查文件系统类型。

3. 在文件系统挂载过程中，为每个分区创建一个设备节点，并使用相应的文件系统驱动来挂载它。

这个方案的测试可以通过在多个分区上创建和读取文件来进行。如果所有分区都能正确挂载，并且文件操作能在所有分区上正确执行，那么这个方案就可以认为是成功的。
